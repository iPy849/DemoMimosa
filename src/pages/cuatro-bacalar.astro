---
import { Image } from 'astro:assets';
import PageLayout from '../layouts/PageLayout.astro';
import ContactForm from '../components/ContactForm.astro';
import Icon from '../components/icons/Icon.astro';
import { t } from '../i18n/utils';
import { images } from '../data/images';
import { getCollection } from 'astro:content';

const esDevelopments = await getCollection('developments', ({ data }) => data.lang === 'es');
const dev = esDevelopments.find((d) => d.data.slug === 'cuatro-bacalar')?.data;

if (!dev) throw new Error('Cuatro Bacalar development not found');

const { housePlan: housePlanImage, plantaBaja: plantaBajaImage, plantaAlta: plantaAltaImage, floorPlanDetail: floorPlanImage } = images.cuatroBacalar;

const gallery = dev.gallery ?? [dev.image];

const amenityIcons: Record<string, string> = {
  'Beach Club Privado': '<circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
  'Seguridad 24/7': '<path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>',
  'Alberca Infinity': '<path d="M2 16c.6.5 1.2 1 2.5 1C7 17 7 15 9.5 15c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1C7 13 7 11 9.5 11c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 20c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.4 2 5 2c2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>',
  'Gimnasio': '<path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/>',
  'Restaurante Gourmet': '<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/>',
  'Muelle Privado': '<path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.4 2 5 2c2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-8.188-3.639a2 2 0 0 1-1.062-2.766L13.917 4"/><path d="M8 16L3 14"/>',
};
---

<PageLayout
  title={`${dev.title} | MIMOSA Real Estate`}
  description={dev.shortDescription ?? dev.description}
  keywords={`cuatro bacalar, ${dev.title}, ${dev.location}, lujo, inversion, caribe mexicano, laguna bacalar`}
>
  <!-- Section 1: Text, Amenities, and Gallery -->
  <section class="pt-32 pb-16 px-6 bg-gradient-to-b from-muted/30 to-background">
    <div class="max-w-7xl mx-auto">
      <!-- Title -->
      <div class="text-center mb-16">
        <div class="flex items-center justify-center gap-2 text-muted-foreground mb-4">
          <Icon name="map-pin" class="w-5 h-5 text-primary" />
          <p class="text-sm tracking-[0.3em] uppercase font-body">{dev.location}</p>
        </div>
        <h1 class="text-5xl md:text-6xl font-headline font-bold text-foreground mb-6 text-balance">{dev.title}</h1>
        <p class="text-xl text-muted-foreground font-body leading-relaxed max-w-3xl mx-auto">{dev.shortDescription}</p>
      </div>

      <div class="grid lg:grid-cols-5 gap-8 items-start">
        <!-- Left: Description + Amenities (40%) -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Description -->
          <div class="space-y-4">
            <h2 class="text-3xl md:text-4xl font-headline font-bold text-foreground">Una Experiencia Unica</h2>
            <p class="text-lg text-muted-foreground font-body leading-relaxed">{dev.description}</p>
            <div class="pt-2">
              <a href="#contact" class="inline-flex items-center gap-2 text-primary font-body font-bold text-sm tracking-wider uppercase hover:gap-4 transition-all">
                <span>AGENDA UNA VISITA</span>
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </a>
            </div>
          </div>

          <!-- Amenities 3x2 Grid (smaller) -->
          <div>
            <h3 class="text-xl font-headline font-bold text-foreground mb-4">Amenidades Exclusivas</h3>
            <div class="grid grid-cols-3 gap-3">
              {dev.amenities.map((amenity: string) => (
                <div class="group flex flex-col items-center gap-2 p-3 rounded-lg bg-card border border-border hover:border-primary/50 transition-all duration-300">
                  <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-primary/20 group-hover:scale-110 transition-all">
                    <svg class="w-5 h-5 text-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <Fragment set:html={amenityIcons[amenity] || '<path d="M20 6 9 17l-5-5"/>'} />
                    </svg>
                  </div>
                  <span class="text-foreground font-body font-medium text-xs text-center leading-tight">{amenity}</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        <!-- Right: Gallery (60%) -->
        <div class="lg:col-span-3">
          <div class="sticky top-24 space-y-3">
            <!-- Main Image -->
            <div class="relative rounded-xl overflow-hidden border border-border shadow-lg aspect-[4/3] bg-card group cursor-pointer">
              {gallery.map((img: string, i: number) => (
                <div
                  class:list={["gallery-slide absolute inset-0 transition-opacity duration-700", i === 0 ? "opacity-100" : "opacity-0"]}
                  data-slide={i}
                  data-gallery-image={img}
                >
                  <img src={img} alt={`${dev.title} - Imagen ${i + 1}`} class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" loading={i === 0 ? "eager" : "lazy"} />
                </div>
              ))}
              {gallery.length > 1 && (
                <>
                  <button id="gallery-prev" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/40 backdrop-blur-sm hover:bg-black/60 text-white rounded-full w-8 h-8 flex items-center justify-center transition-all z-10 hover:scale-110" aria-label="Previous">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                  </button>
                  <button id="gallery-next" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/40 backdrop-blur-sm hover:bg-black/60 text-white rounded-full w-8 h-8 flex items-center justify-center transition-all z-10 hover:scale-110" aria-label="Next">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                  </button>
                </>
              )}
            </div>

            <!-- Thumbnails Grid -->
            {gallery.length > 1 && (
              <div class="grid grid-cols-4 gap-2">
                {gallery.map((img: string, i: number) => (
                  <button
                    class="gallery-thumb group relative aspect-video rounded-md overflow-hidden border-2 transition-all hover:scale-105 cursor-pointer"
                    data-thumb={i}
                    data-active={i === 0}
                  >
                    <img src={img} alt={`Miniatura ${i + 1}`} class="w-full h-full object-cover" loading="lazy" />
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section 2: Our Four Houses (staircase of images) -->
  <section id="houses" class="py-16 px-6 bg-background">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-headline font-bold text-foreground mb-4">Nuestras Cuatro Casas</h2>
        <p class="text-lg text-muted-foreground font-body max-w-2xl mx-auto">Cada residencia ha sido disenada para ofrecer privacidad, lujo y conexion con la naturaleza</p>
      </div>

      <!-- Staircase Layout - 4 identical floor plan images rotated 90Â° -->
      <div class="relative flex items-center justify-center min-h-[400px] md:min-h-[500px] mb-12">
        {[0, 1, 2, 3].map((i) => (
          <div
            class:list={[
              "house-stair absolute transition-all duration-500",
              i === 0 ? "z-10" : "",
              i === 1 ? "z-20" : "",
              i === 2 ? "z-30" : "",
              i === 3 ? "z-40" : "",
            ]}
            style={`
              left: calc(50% - 240px + ${i * 120}px);
              bottom: ${i * 50}px;
            `}
          >
            <div class="relative w-[200px] md:w-[240px]">
              <img src={housePlanImage} alt={`Planta Baja ${i + 1}`} class="w-full h-auto rotate-90" loading="lazy" />
              {i === 0 && (
                <div class="absolute inset-0 bg-[#00355a]/80 rotate-90 flex items-center justify-center">
                  <span class="text-white font-headline font-bold text-base -rotate-90">VENDIDA</span>
                </div>
              )}
            </div>
          </div>
        ))}
      </div>

      <!-- Floor Plans Side by Side (no card, no interactivity) -->
      <div class="max-w-5xl mx-auto mb-12">
        <div class="grid md:grid-cols-2 gap-8 mb-8">
          <div class="space-y-3">
            <h4 class="text-xl font-headline font-bold text-foreground text-center">Planta Baja</h4>
            <img src={plantaBajaImage} alt="Planta Baja" class="w-full h-auto" loading="lazy" />
          </div>
          <div class="space-y-3">
            <h4 class="text-xl font-headline font-bold text-foreground text-center">Planta Alta</h4>
            <img src={plantaAltaImage} alt="Planta Alta" class="w-full h-auto" loading="lazy" />
          </div>
        </div>

        <!-- Single Description Below -->
        <div class="text-center max-w-3xl mx-auto space-y-6">
          <p class="text-muted-foreground font-body leading-relaxed text-lg">Cada casa cuenta con dos niveles, dos recamaras con bano completo, amplia sala-comedor con cocina integrada, alberca privada, estacionamiento techado y terraza con vista panoramica. Diseno arquitectonico contemporaneo con acabados de primer nivel y materiales locales sustentables.</p>
          
          <button
            id="view-floor-plan"
            class="group inline-flex items-center gap-3 bg-primary hover:bg-primary/90 text-white px-8 py-4 rounded-xl font-bold font-body text-sm tracking-wider uppercase transition-all hover:scale-105 shadow-lg hover:shadow-xl"
          >
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            <span>VER PLANOS ARQUITECTONICOS</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Section 3: Map & Virtual Tour -->
  {(dev.mapUrl || dev.virtualTour) && (
    <section class="py-16 px-6 bg-muted/30">
      <div class="max-w-7xl mx-auto">
        <div class="grid md:grid-cols-2 gap-8">
          {dev.mapUrl && (
            <div class="space-y-4">
              <h3 class="text-2xl font-headline font-bold text-foreground">Ubicacion Estrategica</h3>
              <div class="rounded-2xl overflow-hidden border border-border aspect-[4/3] shadow-xl hover:shadow-2xl transition-shadow">
                <iframe src={dev.mapUrl} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade" title={`Map - ${dev.title}`}></iframe>
              </div>
            </div>
          )}
          {dev.virtualTour && (
            <div class="space-y-4">
              <h3 class="text-2xl font-headline font-bold text-foreground">Recorrido Virtual 360</h3>
              <div class="rounded-2xl overflow-hidden border border-border aspect-[4/3] shadow-xl hover:shadow-2xl transition-shadow">
                <iframe src={dev.virtualTour} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" title={`Virtual Tour - ${dev.title}`}></iframe>
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )}

  <!-- Contact Form -->
  <section id="contact" class="py-16 px-6 bg-background">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-headline font-bold text-foreground mb-4">Agenda Tu Visita</h2>
        <p class="text-lg text-muted-foreground font-body">Descubre personalmente la exclusividad de Cuatro Bacalar</p>
      </div>
      <ContactForm variant="card" />
    </div>
  </section>

  <!-- Floor Plan Modal Overlay -->
  <div id="floor-plan-modal" class="hidden fixed inset-0 bg-black/95 z-50 p-6 overflow-auto">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-headline font-bold text-white">Planos Arquitectonicos Detallados</h3>
        <button id="close-floor-plan" class="bg-white/10 backdrop-blur-md hover:bg-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center transition-all hover:scale-110">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <img src={floorPlanImage} alt="Planos Arquitectonicos Detallados" class="w-full h-auto rounded-2xl shadow-2xl" />
    </div>
  </div>

  <!-- Image Lightbox Modal -->
  <div id="lightbox-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-6 cursor-pointer">
    <div class="relative max-w-6xl max-h-full">
      <img id="lightbox-image" src="" alt="" class="max-w-full max-h-[90vh] object-contain rounded-lg" />
      <button id="close-lightbox" class="absolute top-4 right-4 bg-white/10 backdrop-blur-md hover:bg-white/20 text-white rounded-full w-12 h-12 flex items-center justify-center transition-all hover:scale-110">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
      </button>
    </div>
  </div>
</PageLayout>

<style>
  .gallery-thumb[data-active="true"] {
    border-color: hsl(var(--primary));
    box-shadow: 0 0 0 2px hsl(var(--primary) / 0.2);
  }
  .gallery-thumb[data-active="false"] {
    border-color: hsl(var(--border));
  }

  @media (max-width: 768px) {
    .house-stair:nth-child(1) { left: calc(50% - 180px) !important; bottom: 0px !important; }
    .house-stair:nth-child(2) { left: calc(50% - 80px) !important; bottom: 40px !important; }
    .house-stair:nth-child(3) { left: calc(50% + 20px) !important; bottom: 80px !important; }
    .house-stair:nth-child(4) { left: calc(50% + 120px) !important; bottom: 120px !important; }
  }
</style>

<script>
  // Gallery Carousel
  let currentSlide = 0;
  const slides = document.querySelectorAll('.gallery-slide');
  const thumbs = document.querySelectorAll('.gallery-thumb');
  const total = slides.length;

  function goTo(index: number) {
    currentSlide = ((index % total) + total) % total;
    slides.forEach((s, i) => {
      s.classList.toggle('opacity-100', i === currentSlide);
      s.classList.toggle('opacity-0', i !== currentSlide);
    });
    thumbs.forEach((t, i) => {
      t.setAttribute('data-active', i === currentSlide ? 'true' : 'false');
    });
  }

  document.getElementById('gallery-prev')?.addEventListener('click', () => goTo(currentSlide - 1));
  document.getElementById('gallery-next')?.addEventListener('click', () => goTo(currentSlide + 1));
  thumbs.forEach((t, i) => t.addEventListener('click', () => goTo(i)));

  // Gallery main image click to open lightbox
  slides.forEach((slide) => {
    slide.addEventListener('click', () => {
      const imgSrc = slide.getAttribute('data-gallery-image');
      if (imgSrc) {
        const lightbox = document.getElementById('lightbox-modal');
        const lightboxImg = document.getElementById('lightbox-image') as HTMLImageElement;
        if (lightbox && lightboxImg) {
          lightboxImg.src = imgSrc;
          lightbox.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }
    });
  });

  // Close lightbox
  const lightboxModal = document.getElementById('lightbox-modal');
  document.getElementById('close-lightbox')?.addEventListener('click', () => {
    lightboxModal?.classList.add('hidden');
    document.body.style.overflow = '';
  });
  lightboxModal?.addEventListener('click', (e) => {
    if (e.target === lightboxModal) {
      lightboxModal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  });

  // Floor Plan Modal
  const fpModal = document.getElementById('floor-plan-modal');
  document.getElementById('view-floor-plan')?.addEventListener('click', () => {
    fpModal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });
  document.getElementById('close-floor-plan')?.addEventListener('click', () => {
    fpModal?.classList.add('hidden');
    document.body.style.overflow = '';
  });
  fpModal?.addEventListener('click', (e) => {
    if (e.target === fpModal) {
      fpModal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  });
</script>
