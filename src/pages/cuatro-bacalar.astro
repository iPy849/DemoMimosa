
---
import { Image } from 'astro:assets';
import PageLayout from '../layouts/PageLayout.astro';
import ContactForm from '../components/ContactForm.astro';
import Icon from '../components/icons/Icon.astro';
import { images } from '../data/images';
import { getCollection } from 'astro:content';
import '../styles/splide-custom.css';

let dev: any;
try {
  const allDevelopments = await getCollection('developments');
  dev = allDevelopments.find((d) => d.data.slug === 'cuatro-bacalar')?.data;
} catch (e) {
  console.error('[v0] Content collection error:', e);
}

if (!dev) {
  dev = {
    title: 'Cuatro Bacalar',
    location: 'Bacalar, Quintana Roo',
    shortDescription: 'Una experiencia de vida unica frente a la laguna de los siete colores.',
    description: 'Cuatro Bacalar es un desarrollo residencial de lujo disenado para armonizar con la belleza natural de la Laguna de los Siete Colores.',
    amenities: ['Beach Club Privado', 'Seguridad 24/7', 'Alberca Infinity', 'Gimnasio', 'Restaurante Gourmet', 'Muelle Privado'],
    image: '/assets/images/dev-cuatro-bacalar.jpg',
    gallery: ['/assets/images/dev-cuatro-bacalar.jpg', '/assets/images/dev-cuatro-bacalar-2.jpg', '/assets/images/dev-cuatro-bacalar-3.jpg', '/assets/images/dev-cuatro-bacalar-4.jpg'],
    mapUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d15082.4939223793!2d-88.3974443!3d18.6755455!2m3!1f0!2f0!3f0!3m2!1i1024!2i1024!2f1080!3m2!1m1!2zMTjCsDQwJzMyLjAiTiA4OMKwMjMnNTAuOCJX!5e0!3m2!1ses!2smx!4v1700000000000!5m2!1ses!2smx',
    virtualTour: 'https://kuula.co/share/hs7cq/collection/7Dgjf?logo=0&info=0&fs=1&vr=1&initload=0&thumbs=1',
  };
}

const { housePlan: housePlanImage, plantaBaja: plantaBajaImage, plantaAlta: plantaAltaImage, floorPlanDetail: floorPlanImage } = images.cuatroBacalar;

const gallery = dev.gallery ?? [dev.image];

const amenityIcons: Record<string, string> = {
  'Beach Club Privado': '<circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>',
  'Seguridad 24/7': '<path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>',
  'Alberca Infinity': '<path d="M2 16c.6.5 1.2 1 2.5 1C7 17 7 15 9.5 15c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 12c.6.5 1.2 1 2.5 1C7 13 7 11 9.5 11c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M2 20c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.4 2 5 2c2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>',
  'Gimnasio': '<path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/>',
  'Restaurante Gourmet': '<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/>',
  'Muelle Privado': '<path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2s2.4 2 5 2c2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-8.188-3.639a2 2 0 0 1-1.062-2.766L13.917 4"/><path d="M8 16L3 14"/>',
};
---

<PageLayout
  title={`${dev.title} | MIMOSA Real Estate`}
  description={dev.shortDescription ?? dev.description}
  keywords={`cuatro bacalar, ${dev.title}, ${dev.location}, lujo, inversion, caribe mexicano, laguna bacalar`}
  contactForm={false}
>
  <!-- Section 1: Text, Amenities, and Gallery -->
  <section class="pt-32 pb-16 px-6 bg-gradient-to-b from-muted/30 to-background">
    <div class="max-w-7xl mx-auto">
      <!-- Title -->
      <div class="text-center mb-16">
        <div class="flex items-center justify-center gap-2 text-muted-foreground mb-4">
          <Icon name="map-pin" class="w-5 h-5 text-primary" />
          <p class="text-sm tracking-[0.3em] uppercase font-body">{dev.location}</p>
        </div>
        <h1 class="text-5xl md:text-6xl font-headline font-bold text-foreground mb-6 text-balance">{dev.title}</h1>
        <p class="text-xl text-muted-foreground font-body leading-relaxed max-w-3xl mx-auto">{dev.shortDescription}</p>
      </div>

      <div class="grid lg:grid-cols-5 gap-8 items-start">
        <!-- Left: Description + Amenities (40%) -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Description -->
          <div class="space-y-4">
            <h2 class="text-3xl md:text-4xl font-headline font-bold text-foreground">Una Experiencia Unica</h2>
            <p class="text-lg text-muted-foreground font-body leading-relaxed">{dev.description}</p>
            <div class="pt-2">
              <a href="#contact" class="inline-flex items-center gap-2 text-primary font-body font-bold text-sm tracking-wider uppercase hover:gap-4 transition-all">
                <span>AGENDA UNA VISITA</span>
                <Icon name="arrow-right" class="w-5 h-5" />
              </a>
            </div>
          </div>

          <!-- Amenities 3x2 Grid (smaller) -->
          <div>
            <h3 class="text-xl font-headline font-bold text-foreground mb-4">Amenidades Exclusivas</h3>
            <div class="grid grid-cols-3 gap-3">
              {dev.amenities.map((amenity: string) => (
                <div class="group flex flex-col items-center gap-2 p-3 rounded-lg bg-card border border-border hover:border-primary/50 transition-all duration-300">
                  <div class="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-primary/20 group-hover:scale-110 transition-all">
                    <svg class="w-5 h-5 text-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <Fragment set:html={amenityIcons[amenity] || '<path d="M20 6 9 17l-5-5"/>'} />
                    </svg>
                  </div>
                  <span class="text-foreground font-body font-medium text-xs text-center leading-tight">{amenity}</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        <!-- Right: Gallery (60%) -->
        <div class="lg:col-span-3">
          <div class="sticky top-24 space-y-3">
            <!-- Main Slider -->
            <div id="main-carousel" class="splide rounded-xl overflow-hidden border border-border shadow-lg bg-card">
              <div class="splide__track">
                <ul class="splide__list">
                  {gallery.map((img: string, i: number) => (
                    <li class="splide__slide aspect-[4/3] cursor-zoom-in">
                      <img src={img} alt={`${dev.title} - Imagen ${i + 1}`} class="w-full h-full object-cover" loading={i === 0 ? "eager" : "lazy"} />
                    </li>
                  ))}
                </ul>
              </div>
            </div>

            <!-- Thumbnail Slider -->
            <div id="thumbnail-carousel" class="splide mt-3">
              <div class="splide__track">
                <ul class="splide__list">
                  {gallery.map((img: string, i: number) => (
                    <li class="splide__slide aspect-video rounded-md overflow-hidden border border-transparent opacity-50 transition-all cursor-pointer">
                      <img src={img} alt={`Miniatura ${i + 1}`} class="w-full h-full object-cover" loading="lazy" />
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section 3: Map & Virtual Tour -->
  {(dev.mapUrl || dev.virtualTour) && (
    <section class="py-16 px-6 bg-muted/30">
      <div class="max-w-7xl mx-auto">
        <div class="grid md:grid-cols-2 gap-8">
          {dev.mapUrl && (
            <div class="space-y-4">
              <h3 class="text-2xl font-headline font-bold text-foreground">Ubicacion Estrategica</h3>
              <div class="rounded-2xl overflow-hidden border border-border aspect-[4/3] shadow-xl hover:shadow-2xl transition-shadow">
                <iframe src={dev.mapUrl} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade" title={`Map - ${dev.title}`}></iframe>
              </div>
            </div>
          )}
          {dev.virtualTour && (
            <div class="space-y-4">
              <h3 class="text-2xl font-headline font-bold text-foreground">Recorrido Virtual 360</h3>
              <div class="rounded-2xl overflow-hidden border border-border aspect-[4/3] shadow-xl hover:shadow-2xl transition-shadow">
                <iframe src={dev.virtualTour} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" title={`Virtual Tour - ${dev.title}`}></iframe>
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )}

  <!-- Contact Form -->
  <section id="contact" class="py-16 px-6 bg-background">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-headline font-bold text-foreground mb-4">Agenda Tu Visita</h2>
        <p class="text-lg text-muted-foreground font-body">Descubre personalmente la exclusividad de Cuatro Bacalar</p>
      </div>
      <ContactForm variant="card" />
    </div>
  </section>

</PageLayout>

<style>
  @media (max-width: 768px) {
    .house-stair:nth-child(1) { left: calc(50% - 180px) !important; bottom: 0px !important; }
    .house-stair:nth-child(2) { left: calc(50% - 80px) !important; bottom: 40px !important; }
    .house-stair:nth-child(3) { left: calc(50% + 20px) !important; bottom: 80px !important; }
    .house-stair:nth-child(4) { left: calc(50% + 120px) !important; bottom: 120px !important; }
  }
</style>

<script>
  import Splide from '@splidejs/splide';

  document.addEventListener('DOMContentLoaded', () => {
    const mainCarouselEl = document.querySelector('#main-carousel');
    const thumbCarouselEl = document.querySelector('#thumbnail-carousel');

    if (mainCarouselEl && thumbCarouselEl) {
      const main = new Splide('#main-carousel', {
        type: 'fade',
        rewind: true,
        pagination: false,
        arrows: true,
      });

      const thumbnails = new Splide('#thumbnail-carousel', {
        fixedWidth: 100,
        fixedHeight: 64,
        isNavigation: true,
        gap: 12,
        focus: 0,
        pagination: false,
        arrows: false,
        breakpoints: {
          640: {
            fixedWidth: 80,
            fixedHeight: 50,
          },
        },
      });

      main.sync(thumbnails);
      main.mount();
      thumbnails.mount();
    }
  });
</script>
