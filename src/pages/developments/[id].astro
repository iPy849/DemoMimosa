---
import PageLayout from '../../layouts/PageLayout.astro';
import ContactForm from '../../components/ContactForm.astro';
import { t } from '../../i18n/utils';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const esDevelopments = await getCollection('developments', ({ data }) => data.lang === 'es');
  const enDevelopments = await getCollection('developments', ({ data }) => data.lang === 'en');

  return esDevelopments.map((dev) => {
    const enPair = enDevelopments.find((en) => en.data.pairId === dev.data.pairId);
    return {
      params: { id: dev.data.slug },
      props: { dev: dev.data, enDev: enPair?.data ?? null },
    };
  });
}

const { dev, enDev } = Astro.props;
const gallery = dev.gallery ?? [dev.image];
---

<PageLayout title={`${dev.title} | MIMOSA`}>
  <section class="pt-32 pb-24 px-6">
    <div class="max-w-7xl mx-auto">
      <!-- Back link -->
      <a href="/developments" class="inline-flex items-center gap-2 text-primary text-sm tracking-wider uppercase font-bold font-body hover:underline mb-8">
        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        <span data-t="dev.back">{t("dev.back")}</span>
      </a>

      <!-- Title -->
      <h1 class="text-4xl md:text-5xl font-headline font-bold text-foreground mb-4" data-t-dev="title">{dev.title}</h1>
      <div class="flex items-center gap-2 text-primary mb-10">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
        <span class="font-body" data-t-dev="location">{dev.location}</span>
      </div>

      <!-- Main row: Carousel (70%) + Sidebar (30%) -->
      <div class="flex flex-col lg:flex-row gap-8 mb-12">
        <!-- Carousel column -->
        <div class="lg:w-[70%] flex flex-col gap-4">
          <!-- Main image -->
          <div class="relative aspect-[16/10] rounded-lg overflow-hidden bg-card">
            {gallery.map((img: string, i: number) => (
              <img
                src={img}
                alt={`${dev.title} - ${i + 1}`}
                class:list={["carousel-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-500", i === 0 ? "opacity-100" : "opacity-0"]}
                data-slide={i}
                loading={i === 0 ? "eager" : "lazy"}
              />
            ))}
            {gallery.length > 1 && (
              <>
                <button id="carousel-prev" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors" aria-label="Previous">
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <button id="carousel-next" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors" aria-label="Next">
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </button>
              </>
            )}
          </div>
          <!-- Thumbnails -->
          {gallery.length > 1 && (
            <div class="flex gap-3 overflow-x-auto pb-1">
              {gallery.map((img: string, i: number) => (
                <button
                  class:list={["carousel-thumb shrink-0 w-20 h-16 rounded-md overflow-hidden border-2 transition-all cursor-pointer", i === 0 ? "border-primary" : "border-transparent opacity-60 hover:opacity-100"]}
                  data-thumb={i}
                  aria-label={`View image ${i + 1}`}
                >
                  <img src={img} alt={`Thumbnail ${i + 1}`} class="w-full h-full object-cover" loading="lazy" />
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- Sidebar column (~30%): description + amenities -->
        <div class="lg:w-[30%] flex flex-col gap-6">
          <div>
            <p class="text-muted-foreground leading-relaxed font-body" data-t-dev="description">{dev.description}</p>
          </div>
          <div class="bg-card rounded-lg border border-border p-6 flex-1">
            <h3 class="font-headline font-semibold text-foreground mb-4" data-t-dev="amenities-title">Amenidades</h3>
            <ul class="flex flex-col gap-3" id="amenities-list">
              {dev.amenities.map((amenity: string, i: number) => (
                <li class="flex items-center gap-2 text-muted-foreground font-body text-sm" data-amenity-index={i}>
                  <svg class="w-4 h-4 text-primary shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                  <span>{amenity}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>

      <!-- Map + Virtual Tour row (50/50) -->
      {(dev.mapUrl || dev.virtualTour) && (
        <div class="flex flex-col md:flex-row gap-8 mb-16">
          {dev.mapUrl && (
            <div class="md:w-1/2">
              <h3 class="text-xl font-headline font-semibold text-foreground mb-4" data-t="dev.location">{t("dev.location")}</h3>
              <div class="rounded-lg overflow-hidden border border-border aspect-[4/3]">
                <iframe src={dev.mapUrl} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade" title={`Map - ${dev.title}`}></iframe>
              </div>
            </div>
          )}
          {dev.virtualTour && (
            <div class="md:w-1/2">
              <h3 class="text-xl font-headline font-semibold text-foreground mb-4" data-t="dev.360">{t("dev.360")}</h3>
              <div class="rounded-lg overflow-hidden border border-border aspect-[4/3]">
                <iframe src={dev.virtualTour} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" title={`Virtual Tour - ${dev.title}`}></iframe>
              </div>
            </div>
          )}
        </div>
      )}

      <!-- Contact Form -->
      <div class="mt-16">
        <h3 class="text-2xl font-headline font-semibold text-foreground mb-8 text-center" data-t="contact.title">{t("contact.title")}</h3>
        <ContactForm variant="card" />
      </div>
    </div>
  </section>
</PageLayout>

<!-- Embed EN development data for client-side translation -->
{enDev && (
  <script define:vars={{ enDev: JSON.stringify(enDev), esDev: JSON.stringify(dev) }}>
    window.__enDevData = JSON.parse(enDev);
    window.__esDevData = JSON.parse(esDev);
  </script>
)}

<script>
  // Carousel logic
  let currentSlide = 0;
  const slides = document.querySelectorAll('.carousel-slide');
  const thumbs = document.querySelectorAll('.carousel-thumb');
  const total = slides.length;

  function goToSlide(index) {
    currentSlide = ((index % total) + total) % total;
    slides.forEach((s, i) => {
      s.classList.toggle('opacity-100', i === currentSlide);
      s.classList.toggle('opacity-0', i !== currentSlide);
    });
    thumbs.forEach((t, i) => {
      t.classList.toggle('border-primary', i === currentSlide);
      t.classList.toggle('border-transparent', i !== currentSlide);
      t.classList.toggle('opacity-60', i !== currentSlide);
    });
  }

  document.getElementById('carousel-prev')?.addEventListener('click', () => goToSlide(currentSlide - 1));
  document.getElementById('carousel-next')?.addEventListener('click', () => goToSlide(currentSlide + 1));
  thumbs.forEach((thumb, i) => {
    thumb.addEventListener('click', () => goToSlide(i));
  });

  // Development-specific language switching
  // This extends the global lang toggle in BaseLayout by also swapping development content
  const origToggle = document.getElementById('lang-toggle');
  const origToggleMobile = document.getElementById('lang-toggle-mobile');

  function swapDevContent() {
    const lang = document.documentElement.lang;
    const data = lang === 'en' ? window.__enDevData : window.__esDevData;
    if (!data) return;

    document.querySelectorAll('[data-t-dev]').forEach((el) => {
      const field = el.getAttribute('data-t-dev');
      if (field === 'amenities-title') {
        el.textContent = lang === 'en' ? 'Amenities' : 'Amenidades';
      } else if (field && data[field]) {
        el.textContent = data[field];
      }
    });

    // Swap amenities list
    if (data.amenities) {
      document.querySelectorAll('[data-amenity-index]').forEach((el) => {
        const idx = parseInt(el.getAttribute('data-amenity-index') ?? '0');
        const span = el.querySelector('span');
        if (span && data.amenities[idx]) {
          span.textContent = data.amenities[idx];
        }
      });
    }
  }

  // Listen for lang change event dispatched from Navbar
  document.addEventListener('langChanged', swapDevContent);

  // Also run on initial load in case browser language was EN
  swapDevContent();
</script>
