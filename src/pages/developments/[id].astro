---
import { Image } from 'astro:assets';
import PageLayout from '../../layouts/PageLayout.astro';
import ContactForm from '../../components/ContactForm.astro';
import Icon from '../../components/icons/Icon.astro';
import { getCollection } from 'astro:content';
import '../../styles/splide-custom.css';

export async function getStaticPaths() {
  const allDevelopments = await getCollection('developments');

  return allDevelopments.map((dev) => {
    return {
      params: { id: dev.data.slug },
      props: { dev },
    };
  });
}

const { dev } = Astro.props;
const data = dev.data;

// Prepare galleries
const gallery = data.gallery ?? (data.image ? [data.image] : []);

// Map amenity names to icon component names
const amenityIconMap: Record<string, string> = {
  'Beach Club Privado': 'pool',
  'Seguridad 24/7': 'shield',
  'Alberca Infinity': 'pool',
  'Gimnasio': 'gym',
  'Restaurante Gourmet': 'utensils',
  'Muelle Privado': 'anchor',
  'Cenote Privado': 'pool',
  'Spa Holistico': 'spa',
  'Restaurante Organico': 'utensils',
  'Yoga Deck': 'yoga',
  'Bicicletas': 'bike',
};
---

<PageLayout
  title={`${data.title} | MIMOSA Developments`}
  description={data.shortDescription ?? data.description}
  keywords={`desarrollo, ${data.title}, ${data.location}, lujo, inversion, caribe mexicano`}
  image={data.image}
  type="article"
  contactForm={false}
>
  <div id="dev-content">
    <section class="pt-24 sm:pt-28 md:pt-32 pb-12 md:pb-16 px-4 sm:px-6 bg-gradient-to-b from-muted/30 to-background">
      <div class="max-w-7xl mx-auto">
        <!-- Back link -->
        <a href="/developments" class="inline-flex items-center gap-2 text-primary text-xs sm:text-sm tracking-wider uppercase font-bold font-body hover:underline mb-6 sm:mb-8">
          <Icon name="arrow-left" class="w-3 h-3 sm:w-4 sm:h-4" />
          <span>VOLVER A DESARROLLOS</span>
        </a>

        <!-- Title Area -->
        <div class="text-center mb-10 sm:mb-12 md:mb-16">
          <div class="flex items-center justify-center gap-2 text-muted-foreground mb-3 sm:mb-4">
            <Icon name="map-pin" class="w-4 h-4 sm:w-5 sm:h-5 text-primary" />
            <p class="text-xs sm:text-sm tracking-[0.2em] sm:tracking-[0.3em] uppercase font-body">{data.location}</p>
          </div>
          <h1 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-headline font-bold text-foreground mb-4 sm:mb-6 text-balance px-4">{data.title}</h1>
          <p class="text-base sm:text-lg md:text-xl text-muted-foreground font-body leading-relaxed max-w-3xl mx-auto px-4">{data.shortDescription}</p>
        </div>

        <div class="grid lg:grid-cols-5 gap-6 sm:gap-8 items-start">
          <!-- Left: Description + Amenities (40%) -->
          <div class="lg:col-span-2 space-y-6 sm:space-y-8">
            <!-- Description -->
            <div class="space-y-3 sm:space-y-4">
              <h2 class="text-2xl sm:text-3xl md:text-4xl font-headline font-bold text-foreground">Una Experiencia Unica</h2>
              <p class="text-base sm:text-lg text-muted-foreground font-body leading-relaxed">{data.description}</p>
              <div class="pt-2">
                <a href="#contact" class="inline-flex items-center gap-2 text-primary font-body font-bold text-xs sm:text-sm tracking-wider uppercase hover:gap-4 transition-all">
                  <span>AGENDA UNA VISITA</span>
                  <Icon name="arrow-right" class="w-4 h-4 sm:w-5 sm:h-5" />
                </a>
              </div>
            </div>

            <!-- Amenities Grid -->
            <div>
              <h3 class="text-lg sm:text-xl font-headline font-bold text-foreground mb-3 sm:mb-4">Amenidades Exclusivas</h3>
              <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
                {data.amenities.map((amenity: string) => (
                  <div class="group flex flex-col items-center gap-2 p-2 sm:p-3 rounded-lg bg-card border border-border hover:border-primary/50 transition-all duration-300">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-primary/10 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-primary/20 group-hover:scale-110 transition-all">
                      <Icon name={amenityIconMap[amenity] || 'check'} class="w-4 h-4 sm:w-5 sm:h-5 text-primary" />
                    </div>
                    <span class="text-foreground font-body font-medium text-[10px] sm:text-xs text-center leading-tight">{amenity}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <!-- Right: Gallery (60%) -->
          <div class="lg:col-span-3">
            <div class="lg:sticky lg:top-24 space-y-2 sm:space-y-3">
              <!-- Main Slider -->
              <div id="main-carousel" class="splide rounded-lg sm:rounded-xl overflow-hidden border border-border shadow-lg bg-card main-carousel">
                <div class="splide__track">
                  <ul class="splide__list">
                    {gallery.map((img: string, i: number) => (
                      <li class="splide__slide aspect-[4/3]">
                        <Image src={img} alt={`${data.title} - ${i + 1}`} width={1200} height={900} class="w-full h-full object-cover" loading={i === 0 ? "eager" : "lazy"} />
                      </li>
                    ))}
                  </ul>
                </div>
              </div>

              <!-- Thumbnail Slider -->
              {gallery.length > 1 && (
                <div id="thumbnail-carousel" class="splide mt-2 sm:mt-3 thumbnail-carousel">
                  <div class="splide__track">
                    <ul class="splide__list">
                      {gallery.map((img: string, i: number) => (
                        <li class="splide__slide aspect-video rounded-md overflow-hidden border border-transparent opacity-50 transition-all cursor-pointer">
                          <Image src={img} alt={`Thumbnail ${i + 1}`} width={200} height={150} class="w-full h-full object-cover" loading="lazy" />
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Map & Virtual Tour -->
    {(data.mapUrl || data.virtualTour) && (
      <section class="py-12 md:py-16 px-4 sm:px-6 bg-muted/30">
        <div class="max-w-7xl mx-auto">
          <div class="grid md:grid-cols-2 gap-6 sm:gap-8">
            {data.mapUrl && (
              <div class="space-y-3 sm:space-y-4">
                <h3 class="text-xl sm:text-2xl font-headline font-bold text-foreground">Ubicacion Estrategica</h3>
                <div class="rounded-xl sm:rounded-2xl overflow-hidden border border-border aspect-[4/3] shadow-xl hover:shadow-2xl transition-shadow">
                  <iframe src={data.mapUrl} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade" title={`Map - ${data.title}`}></iframe>
                </div>
              </div>
            )}
            {data.virtualTour && (
              <div class="space-y-3 sm:space-y-4">
                <h3 class="text-xl sm:text-2xl font-headline font-bold text-foreground">Recorrido Virtual 360</h3>
                <div class="rounded-xl sm:rounded-2xl overflow-hidden border border-border aspect-[4/3] shadow-xl hover:shadow-2xl transition-shadow">
                  <iframe src={data.virtualTour} width="100%" height="100%" style="border:0;" allowfullscreen loading="lazy" title={`Virtual Tour - ${data.title}`}></iframe>
                </div>
              </div>
            )}
          </div>
        </div>
      </section>
    )}
  </div>

  <!-- Contact Form -->
  <section id="contact" class="py-12 md:py-16 px-4 sm:px-6 bg-background">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-8 sm:mb-10 md:mb-12">
        <h2 class="text-2xl sm:text-3xl md:text-4xl font-headline font-bold text-foreground mb-3 sm:mb-4 px-4">Inicia Tu Proxima Inversion</h2>
        <p class="text-base sm:text-lg text-muted-foreground font-body px-4">
          Descubre personalmente la exclusividad de {data.title}
        </p>
      </div>
      <ContactForm variant="card" />
    </div>
  </section>
</PageLayout>

<script>
  import Splide from '@splidejs/splide';

  function initSplide() {
    const mainCarouselEl = document.querySelector('#main-carousel');
    const thumbCarouselEl = document.querySelector('#thumbnail-carousel');

    if (mainCarouselEl && !mainCarouselEl.classList.contains('is-initialized')) {
      mainCarouselEl.classList.add('is-initialized');

      const hasMultipleSlides = mainCarouselEl.querySelectorAll('.splide__slide').length > 1;

      const main = new Splide('#main-carousel', {
        type: 'fade',
        rewind: true,
        pagination: false,
        arrows: hasMultipleSlides,
        drag: hasMultipleSlides,
      });

      if (thumbCarouselEl) {
        const thumbnails = new Splide('#thumbnail-carousel', {
          fixedWidth: 100,
          fixedHeight: 64,
          isNavigation: true,
          gap: 12,
          focus: 0,
          pagination: false,
          arrows: false,
          breakpoints: {
            640: {
              fixedWidth: 80,
              fixedHeight: 50,
            },
          },
        });

        main.sync(thumbnails);
        main.mount();
        thumbnails.mount();
      } else {
        main.mount();
      }
    }
  }

  document.addEventListener('astro:page-load', initSplide);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSplide);
  } else {
    initSplide();
  }
</script>
